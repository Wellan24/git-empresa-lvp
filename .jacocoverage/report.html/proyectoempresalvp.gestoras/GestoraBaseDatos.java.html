<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>GestoraBaseDatos.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">JaCoCoverage analysis of project &quot;ProyectoEmpresaLVP&quot; (powered by JaCoCo from EclEmma)</a> &gt; <a href="index.source.html" class="el_package">proyectoempresalvp.gestoras</a> &gt; <span class="el_source">GestoraBaseDatos.java</span></div><h1>GestoraBaseDatos.java</h1><pre class="source lang-java linenums">/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package proyectoempresalvp.gestoras;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.logging.Level;
import java.util.logging.Logger;
import proyectoempresalvp.datos.Dato;
import proyectoempresalvp.datos.Fecha;

/**
 *
 * @author Oscar
 */
<span class="nc" id="L22">public class GestoraBaseDatos {</span>

    public static Connection conexion;

    public static boolean conectarBaseDatos() {

        try {

<span class="fc" id="L30">            Class.forName(&quot;net.ucanaccess.jdbc.UcanaccessDriver&quot;);</span>

<span class="pc bpc" id="L32" title="1 of 2 branches missed.">            if(GestoraBaseDatos.conexion == null) {</span>

<span class="fc" id="L34">                GestoraBaseDatos.conexion = DriverManager.getConnection(&quot;jdbc:ucanaccess://../DataBase/BaseDeDatosLVP.accdb&quot;);</span>
            }
<span class="nc" id="L36">        } catch(ClassNotFoundException ex) {</span>
<span class="nc" id="L37">            Logger.getLogger(GestoraBaseDatos.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L38">            return false;</span>
<span class="nc" id="L39">        } catch(SQLException ex) {</span>
<span class="nc" id="L40">            Logger.getLogger(GestoraBaseDatos.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="fc" id="L41">        }</span>

<span class="fc" id="L43">        return true;</span>
    }

    public static boolean ejecutarSentenciaUpdate(String textoSentencia) {

        Statement sentenciaLocal;
<span class="nc" id="L49">        ResultSet dev = null;</span>
        try {
            
<span class="nc" id="L52">            sentenciaLocal = GestoraBaseDatos.conexion.createStatement();</span>
<span class="nc" id="L53">            System.out.println(textoSentencia);</span>
<span class="nc" id="L54">            int result = sentenciaLocal.executeUpdate(textoSentencia);</span>

<span class="nc bnc" id="L56" title="All 2 branches missed.">            return result == 1;</span>
<span class="nc" id="L57">        } catch(SQLException ex) {</span>
<span class="nc" id="L58">            Logger.getLogger(GestoraBaseDatos.class.getName()).log(Level.SEVERE, null, ex);</span>
        }
<span class="nc" id="L60">        return false;</span>
    }

    /**
     * @param textoSentencia
     * @return Devuelve un ResultSet con los datos de la consulta o null si hay una excepci√≥n
     */
    public synchronized static ResultSet ejecutarSentenciaQuery(String textoSentencia) {

        Statement sentenciaLocal;
<span class="fc" id="L70">        ResultSet dev = null;</span>
        try {
            
<span class="fc" id="L73">            sentenciaLocal = GestoraBaseDatos.conexion.createStatement();</span>
<span class="fc" id="L74">            System.out.println(textoSentencia);</span>
<span class="fc" id="L75">            dev = sentenciaLocal.executeQuery(textoSentencia);</span>

<span class="nc" id="L77">        } catch(SQLException ex) {</span>
<span class="nc" id="L78">            Logger.getLogger(GestoraBaseDatos.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="fc" id="L79">        }</span>

<span class="fc" id="L81">        return dev;</span>
    }

    public static void cerrarConexion() {

        try {

<span class="nc" id="L88">            GestoraBaseDatos.conexion.commit();</span>
<span class="nc" id="L89">            GestoraBaseDatos.conexion.close();</span>
<span class="nc" id="L90">        } catch(SQLException ex) {</span>
<span class="nc" id="L91">            Logger.getLogger(GestoraBaseDatos.class.getName()).log(Level.SEVERE, null, ex);</span>
<span class="nc" id="L92">        }</span>
<span class="nc" id="L93">    }</span>

    public static boolean insertarDato(Dato d) {

<span class="nc" id="L97">        String[] claves = d.devuelveOrdenDeColumnas();</span>

<span class="nc bnc" id="L99" title="All 2 branches missed.">        if(!comprobarExiste(d)) {</span>

<span class="nc" id="L101">            StringBuilder textoSentencia = construyeSentenciaInsert(d, claves);</span>
<span class="nc" id="L102">            GestoraBaseDatos.ejecutarSentenciaUpdate(textoSentencia.toString());</span>
<span class="nc" id="L103">            return comprobarExiste(d);</span>
        }
<span class="nc" id="L105">        return false;</span>
    }

    public static boolean comprobarExiste(Dato d) {
<span class="nc" id="L109">        String primaryKey = d.devuelveClave();</span>
        Statement sentenciaLocal;
        try {
<span class="nc" id="L112">            sentenciaLocal = GestoraBaseDatos.conexion.createStatement();</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">            if(!primaryKey.contains(&quot; &quot;)) {</span>

<span class="nc" id="L115">                ResultSet rs = sentenciaLocal.executeQuery(&quot;Select &quot; + primaryKey + &quot; from &quot; + d.devuelveNombreTablaDato()</span>
                        + &quot; where &quot; + primaryKey + &quot; = &quot;
<span class="nc bnc" id="L117" title="All 2 branches missed.">                        + ((d.get(primaryKey) instanceof String) ? &quot;'&quot; + d.get(primaryKey) + &quot;'&quot; : d.get(primaryKey)));</span>

<span class="nc" id="L119">                return rs.next();</span>

            } else {
<span class="nc" id="L122">                String[] key = primaryKey.split(&quot; &quot;);</span>
<span class="nc" id="L123">                ResultSet rs = sentenciaLocal.executeQuery(&quot;Select &quot; + key[0] + &quot;, &quot; + key[1] + &quot; from &quot; + d.devuelveNombreTablaDato()</span>
                        + &quot; where &quot; + key[0] + &quot; = &quot;
<span class="nc bnc" id="L125" title="All 2 branches missed.">                        + ((d.get(key[0]) instanceof String) ? &quot;'&quot; + d.get(key[0]) + &quot;'&quot; : d.get(key[0]))</span>
                        + &quot; AND &quot; + key[1] + &quot; = &quot;
<span class="nc bnc" id="L127" title="All 2 branches missed.">                        + ((d.get(key[1]) instanceof String) ? &quot;'&quot; + d.get(key[1]) + &quot;'&quot; : d.get(key[1]))</span>
                );

<span class="nc" id="L130">                return rs.next();</span>
            }
<span class="nc" id="L132">        } catch(SQLException ex) {</span>
<span class="nc" id="L133">            Logger.getLogger(GestoraBaseDatos.class.getName()).log(Level.SEVERE, null, ex);</span>
        }
<span class="nc" id="L135">        return false;</span>
    }

    private static StringBuilder construyeSentenciaInsert(Dato d, String[] claves) {

<span class="nc" id="L140">        StringBuilder textoSentencia = new StringBuilder(&quot;insert into &quot;);</span>
<span class="nc" id="L141">        textoSentencia.append(d.devuelveNombreTablaDato());</span>
<span class="nc" id="L142">        textoSentencia.append(&quot;(&quot;);</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        for(String clave :claves) {</span>

<span class="nc" id="L145">            textoSentencia.append(clave).append(&quot;,&quot;);</span>
        }
<span class="nc" id="L147">        textoSentencia.replace(textoSentencia.length() - 1, textoSentencia.length(), &quot;)&quot;);</span>
<span class="nc" id="L148">        textoSentencia.append(&quot; VALUES(&quot;);</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">        for(String clave :claves) {</span>

<span class="nc" id="L151">            Object rec = d.get(clave);</span>
<span class="nc bnc" id="L152" title="All 4 branches missed.">            if(rec instanceof String || rec instanceof Fecha) {</span>

<span class="nc" id="L154">                textoSentencia.append(&quot;'&quot;);</span>
<span class="nc" id="L155">                textoSentencia.append(rec.toString());</span>
<span class="nc" id="L156">                textoSentencia.append(&quot;'&quot;);</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            } else if(rec instanceof Integer) {</span>

<span class="nc" id="L159">                textoSentencia.append(rec);</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">            } else if(rec instanceof Float) {</span>

<span class="nc" id="L162">                textoSentencia.append(rec);</span>
            } else {

<span class="nc" id="L165">                textoSentencia.append(rec);</span>
            }
<span class="nc" id="L167">            textoSentencia.append(&quot; ,&quot;);</span>
        }
<span class="nc" id="L169">        textoSentencia.replace(textoSentencia.length() - 2, textoSentencia.length(), &quot;);&quot;);</span>

<span class="nc" id="L171">        return textoSentencia;</span>
    }

    public static boolean updateDato(Dato d) {

<span class="nc bnc" id="L176" title="All 2 branches missed.">        if(comprobarExiste(d)) {</span>

<span class="nc" id="L178">            return ejecutarSentenciaUpdate(construyeSentenciaUpdate(d).toString());</span>
        }

<span class="nc" id="L181">        return false;</span>
    }

    public static StringBuilder construyeSentenciaUpdate(Dato d) {

<span class="nc" id="L186">        String[] claves = d.devuelveOrdenDeColumnas();</span>
<span class="nc" id="L187">        StringBuilder textoSentencia = new StringBuilder(&quot;update &quot;);</span>
<span class="nc" id="L188">        textoSentencia.append(d.devuelveNombreTablaDato());</span>
<span class="nc" id="L189">        textoSentencia.append(&quot; set &quot;);</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">        for(int i = 1;i &lt; claves.length;i++) {</span>

<span class="nc" id="L192">            Object rec = d.get(claves[i]);</span>
<span class="nc" id="L193">            textoSentencia.append(claves[i]).append(&quot;=&quot;);</span>

<span class="nc bnc" id="L195" title="All 4 branches missed.">            if(rec instanceof String || rec instanceof Fecha) {</span>

<span class="nc" id="L197">                textoSentencia.append(&quot;'&quot;);</span>
<span class="nc" id="L198">                textoSentencia.append(rec.toString());</span>
<span class="nc" id="L199">                textoSentencia.append(&quot;'&quot;);</span>
<span class="nc bnc" id="L200" title="All 2 branches missed.">            } else if(rec instanceof Integer) {</span>

<span class="nc" id="L202">                textoSentencia.append(rec);</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">            } else if(rec instanceof Float) {</span>

<span class="nc" id="L205">                textoSentencia.append(rec);</span>
            } else {

<span class="nc" id="L208">                textoSentencia.append(rec);</span>
            }
<span class="nc" id="L210">            textoSentencia.append(&quot; ,&quot;);</span>
        }

<span class="nc" id="L213">        textoSentencia.replace(textoSentencia.length() - 2, textoSentencia.length(), &quot; where &quot;);</span>
<span class="nc" id="L214">        textoSentencia.append(claves[0]).append(&quot; = &quot;).append(d.get(claves[0]));</span>
<span class="nc" id="L215">        return textoSentencia;</span>
    }

    public static String construyeSentenciaSelect(String[] claves, String nombreTabla) {

<span class="fc" id="L220">        StringBuilder dev = new StringBuilder(&quot;Select &quot;);</span>

<span class="fc bfc" id="L222" title="All 2 branches covered.">        for(String clave :claves) {</span>

<span class="fc" id="L224">            dev.append(clave).append(&quot;,&quot;);</span>
        }

<span class="fc" id="L227">        dev.replace(dev.length() - 1, dev.length(), &quot; from &quot; + nombreTabla);</span>

<span class="fc" id="L229">        return dev.toString();</span>
    }

    public static String construyeSentenciaSelect(String[] claves, String nombreTabla, String where) {

<span class="nc" id="L234">        StringBuilder dev = new StringBuilder(&quot;Select &quot;);</span>

<span class="nc bnc" id="L236" title="All 2 branches missed.">        for(String clave :claves) {</span>

<span class="nc" id="L238">            dev.append(clave).append(&quot;,&quot;);</span>
        }

<span class="nc" id="L241">        dev.replace(dev.length() - 1, dev.length(), &quot; from &quot;);</span>
<span class="nc" id="L242">        dev.append(nombreTabla).append(&quot; &quot;).append(where);</span>

<span class="nc" id="L244">        return dev.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>